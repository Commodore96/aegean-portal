<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aegean Tech ‚Ä¢ Portal</title>
<style>
:root{
  --bg:#0b1220;--text:#e7eefb;--muted:#a9b7d6;
  --panel:#10182b;--panel2:#0e172a;--chip:rgba(255,255,255,.08);
  --accent:#6aa8ff;--accent2:#ffd166;--ok:#2ecc71;--bad:#e74c3c;--warn:#f39c12;
  --b:#1b2a4a;--radius:16px;--shadow:0 10px 26px rgba(0,0,0,.35)
}
*{box-sizing:border-box} html,body{height:100%;margin:0}
body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
a{color:var(--accent);text-decoration:none}
.app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
.sidebar{background:var(--panel2);padding:18px 14px;position:sticky;top:0;height:100vh}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
.logo{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.title{font-weight:800}
.muted{color:var(--muted);font-size:12px}
.nav button{width:100%;text-align:left;background:var(--chip);border:1px solid rgba(255,255,255,.08);color:var(--text);padding:10px 12px;border-radius:12px;margin-bottom:8px;cursor:pointer}
.nav button.active{outline:2px solid var(--accent)}
.top{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(0,0,0,.15);border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;backdrop-filter:blur(8px);z-index:5}
.right{display:flex;gap:8px;align-items:center}
.btn{background:#0f1830;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
.btn.small{padding:6px 10px}
.wrap{padding:18px;max-width:1200px;margin:0 auto}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:260px}
h1,h2,h3{margin:0 0 10px}
input,select,button,textarea{background:#0f1830;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px}
input[type="file"]{padding:8px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:var(--chip);border:1px solid rgba(255,255,255,.12)}
.kpi{display:flex;align-items:center;justify-content:space-between}
.kpi .num{font-weight:800;font-size:22px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:14px}
.hidden{display:none}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.ok{background:#0f2a1b;border-color:#1b5a3a}
.bad{background:#2a1517;border-color:#572a2e}
.warn{background:#2a230f;border-color:#5c4b1a}
.light body{background:#f5f7fb;color:#0b1220}
</style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">Aegean Tech</div>
        <div class="muted">Business Portal</div>
      </div>
    </div>
    <div class="nav">
      <button data-tab="Dashboard" class="active">Dashboard</button>
      <button data-tab="Proposals">Proposals</button>
      <button data-tab="Clients">Clients</button>
      <button data-tab="Templates">Templates</button>
      <button data-tab="Reporting">Reporting</button>
      <button data-tab="Settings">Settings</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main>
    <div class="top">
      <div><strong id="tabTitle">Dashboard</strong></div>
      <div class="right">
        <button id="themeBtn" class="btn small">‚òÄÔ∏è / üåô</button>
        <span class="muted" id="userEmail">Not signed in</span>
        <button id="logoutBtn" class="btn small">Logout</button>
      </div>
    </div>

    <div class="wrap">

      <!-- AUTH VIEW -->
      <section id="view-login" class="card">
        <h2>Sign in</h2>
        <div class="row">
          <div class="col"><input id="email" placeholder="Email" value="admin@aegeantech.com"></div>
          <div class="col"><input id="password" placeholder="Password" type="password"></div>
          <div class="col"><button id="loginBtn" class="btn">Login</button></div>
        </div>
        <p class="muted">Defined via <code>AEG_USERS</code> environment variable on the server.</p>
      </section>

      <!-- APP VIEW -->
      <section id="view-app" class="hidden">

        <!-- DASHBOARD -->
        <section id="Dashboard" class="card">
          <h2>Dashboard</h2>
          <div class="row">
            <div class="col card">
              <h3>Quick Actions</h3>
              <div class="row">
                <button class="btn" id="qaClient">Ôºã New Client</button>
                <button class="btn" id="qaProposal">Ôºã New Proposal</button>
                <button class="btn" id="qaTemplate">‚Üë Upload Template</button>
              </div>
            </div>
            <div class="col card">
              <h3>KPIs</h3>
              <div class="row">
                <div class="col card kpi"><span>Clients</span><span id="kpiClients" class="num">0</span></div>
                <div class="col card kpi"><span>Pipeline ‚Ç¨</span><span id="kpiPipeline" class="num">0</span></div>
                <div class="col card">
                  <div>Proposals</div>
                  <div class="row">
                    <span class="badge" id="kpiDraft">draft:0</span>
                    <span class="badge" id="kpiSent">sent:0</span>
                    <span class="badge" id="kpiWon">won:0</span>
                    <span class="badge" id="kpiLost">lost:0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col card">
              <h3>Upcoming Meetings</h3>
              <ul id="kpiUpcoming"></ul>
            </div>
            <div class="col card">
              <h3>Notes</h3>
              <p class="muted">Use the left tabs to manage your work.</p>
            </div>
          </div>
        </section>

        <!-- PROPOSALS -->
        <section id="Proposals" class="card hidden">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h2>Proposals</h2>
            <div class="row">
              <select id="propClient"></select>
              <input id="propTitle" placeholder="Title">
              <select id="propCategory">
                <option>Maritime</option><option>Yachting</option>
                <option>Real Estate</option><option>Hospitality</option>
                <option>Public</option><option>Enterprise</option>
              </select>
              <select id="propStatus"><option>draft</option><option>sent</option><option>won</option><option>lost</option></select>
              <input id="propValue" type="number" step="0.01" placeholder="Value (‚Ç¨)">
              <input id="propDue" type="date">
              <input id="propFile" type="file">
              <button id="addProposalBtn" class="btn">Add</button>
            </div>
          </div>
          <table class="table" id="proposalsTable">
            <thead>
              <tr><th>ID</th><th>Client</th><th>Title</th><th>Category</th><th>Status</th><th>‚Ç¨</th><th>Due</th><th>File</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- CLIENTS -->
        <section id="Clients" class="card hidden">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h2>Clients</h2>
            <div class="row">
              <input id="clientName" placeholder="Name">
              <input id="clientIndustry" placeholder="Industry">
              <input id="clientContact" placeholder="Contact">
              <button id="addClientBtn" class="btn">Add</button>
            </div>
          </div>
          <table class="table" id="clientsTable">
            <thead><tr><th>ID</th><th>Name</th><th>Industry</th><th>Contact</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- TEMPLATES -->
        <section id="Templates" class="card hidden">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h2>Templates</h2>
            <div class="row">
              <input id="tplFile" type="file">
              <button id="uploadTplBtn" class="btn">Upload</button>
            </div>
          </div>
          <table class="table" id="templatesTable">
            <thead><tr><th>ID</th><th>Filename</th><th>Size</th><th>Uploaded</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- REPORTING -->
        <section id="Reporting" class="card hidden">
          <h2>Reporting</h2>
          <div class="row">
            <div class="col card">
              <h3>Summary</h3>
              <p>Clients: <strong id="rClients">0</strong></p>
              <p>Pipeline value: <strong id="rPipeline">0 ‚Ç¨</strong></p>
              <p>Proposals: <span id="rDraft"></span> / <span id="rSent"></span> / <span id="rWon"></span> / <span id="rLost"></span></p>
            </div>
            <div class="col card">
              <h3>Upcoming Meetings</h3>
              <ul id="rUpcoming"></ul>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="Settings" class="card hidden">
          <h2>Settings</h2>
          <div class="row">
            <div class="col card">
              <h3>Theme</h3>
              <button id="toggleThemeBtn" class="btn">Toggle Dark/Light</button>
            </div>
            <div class="col card">
              <h3>Email (SMTP) Test</h3>
              <input id="testEmailTo" placeholder="Send test to (email)">
              <button id="sendTestEmailBtn" class="btn">Send Test Email</button>
              <p class="muted">Configure SMTP env vars on the server.</p>
            </div>
          </div>
        </section>

      </section>
    </div>
  </main>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const state = {
  token: localStorage.getItem("token") || "",
  email: localStorage.getItem("email") || "",
  active: "Dashboard"
};

function setActive(name){
  state.active = name;
  document.querySelectorAll("section.card").forEach(s=>{
    const id = s.getAttribute("id");
    if(!id) return;
    if(["Dashboard","Proposals","Clients","Templates","Reporting","Settings"].includes(id)){
      s.classList.toggle("hidden", id!==name);
    }
  });
  document.querySelectorAll(".nav button").forEach(b=>{
    b.classList.toggle("active", b.dataset.tab===name);
  });
  $("tabTitle").textContent = name;
}

async function api(path, opts={}){
  opts.headers = Object.assign({"Authorization":"Bearer "+state.token}, opts.headers||{});
  const r = await fetch(path, opts);
  if(r.status===401){ logout(); throw new Error("Unauthorized"); }
  const ct = r.headers.get("content-type")||"";
  if(ct.includes("application/json")) return r.json();
  return r.text();
}

function bytes(n){
  n=Number(n||0);
  if(n<1024) return n+" B";
  if(n<1024*1024) return (n/1024).toFixed(1)+" KB";
  if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+" MB";
  return (n/1024/1024/1024).toFixed(1)+" GB";
}

/* THEME */
$("themeBtn").onclick = ()=>{
  document.documentElement.classList.toggle("light");
};
$("toggleThemeBtn") && ($("toggleThemeBtn").onclick = $("themeBtn").onclick);

/* NAV */
document.querySelectorAll(".nav button").forEach(b=>{
  b.onclick = ()=> setActive(b.dataset.tab);
});

/* AUTH */
function showApp(){ $("view-login").classList.add("hidden"); $("view-app").classList.remove("hidden"); }
function showLogin(){ $("view-app").classList.add("hidden"); $("view-login").classList.remove("hidden"); }
$("loginBtn").onclick = async ()=>{
  const email=$("email").value.trim(), password=$("password").value.trim();
  const r = await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,password})});
  if(!r.ok){ alert("Login failed"); return; }
  const data = await r.json();
  state.token = data.token; state.email = data.email;
  localStorage.setItem("token", state.token); localStorage.setItem("email", state.email);
  $("userEmail").textContent = state.email;
  showApp(); setActive("Dashboard"); await refreshAll();
};
$("logoutBtn").onclick = logout;
function logout(){
  localStorage.removeItem("token"); localStorage.removeItem("email");
  state.token=""; state.email=""; $("userEmail").textContent="Not signed in"; showLogin();
}

/* DASHBOARD / REPORTING */
async function refreshKPIs(){
  const k = await api("/api/reporting/kpis");
  $("kpiClients").textContent = k.clients;
  $("kpiPipeline").textContent = k.pipeline_value;
  $("kpiDraft").textContent = "draft:"+k.proposals.draft;
  $("kpiSent").textContent = "sent:"+k.proposals.sent;
  $("kpiWon").textContent = "won:"+k.proposals.won;
  $("kpiLost").textContent = "lost:"+k.proposals.lost;
  $("rClients").textContent = k.clients;
  $("rPipeline").textContent = k.pipeline_value+" ‚Ç¨";
  $("rDraft").textContent = "draft: "+k.proposals.draft;
  $("rSent").textContent  = "sent: "+k.proposals.sent;
  $("rWon").textContent   = "won: "+k.proposals.won;
  $("rLost").textContent  = "lost: "+k.proposals.lost;
  $("kpiUpcoming").innerHTML = (k.upcoming_meetings||[]).map(m=>`<li><strong>${m.title}</strong> ‚Äî ${m.start_at} ${m.location?("("+m.location+")"):""}</li>`).join("");
  $("rUpcoming").innerHTML = $("kpiUpcoming").innerHTML;
}

/* CLIENTS */
async function renderClients(){
  const data = await api("/api/clients");
  const tbody = $("clientsTable").querySelector("tbody");
  tbody.innerHTML = data.map(r=>`
    <tr>
      <td>${r.id}</td><td>${r.name}</td><td>${r.industry||""}</td><td>${r.contact||""}</td>
      <td><button class="btn small" data-act="del" data-id="${r.id}">Delete</button></td>
    </tr>`).join("");
  // proposals dropdown
  $("propClient").innerHTML = data.map(c=>`<option value="${c.id}">${c.id} ‚Äî ${c.name}</option>`).join("");
  tbody.querySelectorAll('button[data-act="del"]').forEach(b=>{
    b.onclick = async ()=>{ if(confirm("Delete this client and related data?")){ await api("/api/clients/"+b.dataset.id,{method:"DELETE"}); await renderClients(); }};
  });
}
$("addClientBtn").onclick = async ()=>{
  const name=$("clientName").value.trim(), industry=$("clientIndustry").value.trim(), contact=$("clientContact").value.trim();
  if(!name) return alert("Name required");
  await api("/api/clients",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name,industry,contact})});
  $("clientName").value=""; $("clientIndustry").value=""; $("clientContact").value="";
  await renderClients(); await refreshKPIs();
};

/* PROPOSALS */
async function renderProposals(){
  const data = await api("/api/proposals");
  const tbody = $("proposalsTable").querySelector("tbody");
  tbody.innerHTML = data.map(p=>`
    <tr>
      <td>${p.id}</td>
      <td>${p.client_id}</td>
      <td>${p.title}</td>
      <td><span class="badge">${p.category}</span></td>
      <td><span class="badge">${p.status}</span></td>
      <td>${Number(p.value_amount||0).toFixed(2)}</td>
      <td>${p.due_date||""}</td>
      <td>${p.file_id?`<a href="/api/proposals/download/${p.id}" target="_blank">Download</a>`:""}</td>
      <td><button class="btn small" data-id="${p.id}" data-act="del">Delete</button></td>
    </tr>`).join("");
  tbody.querySelectorAll('button[data-act="del"]').forEach(b=>{
    b.onclick = async ()=>{ if(confirm("Delete proposal?")){ await api("/api/proposals/"+b.dataset.id,{method:"DELETE"}); await renderProposals(); await refreshKPIs(); } };
  });
}
$("addProposalBtn").onclick = async ()=>{
  const client_id=$("propClient").value, title=$("propTitle").value.trim();
  const category=$("propCategory").value, status=$("propStatus").value;
  const value_amount=$("propValue").value, due_date=$("propDue").value || null;
  if(!client_id || !title) return alert("Client & Title required");
  const f = $("propFile").files[0];
  if(f){
    const form=new FormData();
    form.append("client_id", client_id);
    form.append("title", title);
    form.append("category", category);
    form.append("status", status);
    form.append("value_amount", value_amount);
    form.append("currency", "EUR");
    if(due_date) form.append("due_date", due_date);
    form.append("file", f);
    const r = await fetch("/api/proposals",{method:"POST",headers:{"Authorization":"Bearer "+state.token},body:form});
    if(!r.ok){ alert("Failed to add"); return; }
  } else {
    await api("/api/proposals",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id,title,category,status,value_amount,currency:"EUR",due_date})});
  }
  $("propTitle").value=""; $("propValue").value=""; $("propDue").value=""; $("propFile").value="";
  await renderProposals(); await refreshKPIs();
};

/* TEMPLATES */
async function renderTemplates(){
  const data = await api("/api/templates");
  const tbody = $("templatesTable").querySelector("tbody");
  tbody.innerHTML = data.map(r=>`
    <tr>
      <td>${r.id}</td>
      <td>${r.filename}</td>
      <td>${bytes(r.size_bytes)}</td>
      <td>${(r.created_at||"").slice(0,19).replace("T"," ")}</td>
      <td><a href="/api/templates/download/${r.id}" target="_blank">Download</a></td>
    </tr>`).join("");
}
$("uploadTplBtn").onclick = async ()=>{
  const f = $("tplFile").files[0];
  if(!f) return alert("Choose a file");
  const form = new FormData(); form.append("file", f);
  const r = await fetch("/api/templates/upload",{method:"POST",headers:{"Authorization":"Bearer "+state.token},body:form});
  if(!r.ok){ alert("Upload failed"); return; }
  $("tplFile").value=""; await renderTemplates();
};

/* SETTINGS ‚Äî EMAIL TEST */
$("sendTestEmailBtn").onclick = async ()=>{
  const to = $("testEmailTo").value.trim() || state.email;
  const r = await api("/api/email/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to})});
  alert(r.ok ? "Sent!" : ("Failed: "+r.msg));
};

/* QUICK ACTIONS */
$("qaClient").onclick = ()=> setActive("Clients");
$("qaProposal").onclick = ()=> setActive("Proposals");
$("qaTemplate").onclick = ()=> setActive("Templates");

/* BOOT */
async function refreshAll(){
  await Promise.all([refreshKPIs(), renderClients(), renderProposals(), renderTemplates()]);
}
if(state.token){
  $("userEmail").textContent = state.email || "Signed in";
  $("view-login").classList.add("hidden");
  $("view-app").classList.remove("hidden");
  setActive("Dashboard");
  refreshAll();
} else {
  setActive("Dashboard");
}
</script>
</body>
</html>
