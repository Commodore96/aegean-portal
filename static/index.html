<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aegean Tech â€¢ Portal</title>

<style>
:root{
  --bg:#0b0d12; --fg:#e9edf2; --muted:#a5adbb; --line:#1a2030;
  --panel:#0f131b; --panel2:#0d1118; --chip:#101623;
  --radius:14px; --shadow:0 12px 32px rgba(0,0,0,.35);
}
*{box-sizing:border-box} html,body{height:100%} body{margin:0;font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
a{color:inherit;text-decoration:none} ::selection{background:#334155}
.layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
aside{background:var(--panel2);border-right:1px solid var(--line);position:sticky;top:0;height:100vh;padding:18px 12px}
.brand{display:flex;gap:12px;align-items:center;margin:6px 8px 18px}
.brand-logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#fff,#808080)}
.brand h1{font-size:16px;margin:0;font-weight:800}
.brand .muted{color:var(--muted);font-size:12px;margin-top:2px}
.nav .item{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;margin:6px 6px;border-radius:12px;border:1px solid var(--line);background:var(--chip);cursor:pointer}
.nav .item.active{outline:2px solid rgba(255,255,255,.35)}
.nav .item svg{width:18px;height:18px;stroke:#cbd5e1}
.top{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(9,11,16,.6);backdrop-filter:saturate(120%) blur(10px);border-bottom:1px solid var(--line)}
.container{padding:18px;max-width:1300px;margin:0 auto}
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
.headerline{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
.col{flex:1;min-width:280px}
.btn{background:#0f1420;border:1px solid var(--line);color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer}
.btn.small{padding:6px 10px} .btn.ghost{background:transparent}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:#0e1422;padding:4px 8px;border-radius:999px;font-size:12px}
.note{color:var(--muted);font-size:12px}
input,select,textarea{width:100%;background:#0f1420;color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:10px 12px}
input[type=file]{padding:8px}
.toast{position:fixed;right:16px;bottom:16px;background:#0f1420;border:1px solid var(--line);padding:10px 14px;border-radius:12px}

/* Tables: smart, minimal */
.table{width:100%;border-collapse:separate;border-spacing:0 6px}
.table thead th{position:sticky;top:0;background:var(--panel);z-index:1;border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:12px;letter-spacing:.03em;color:#cbd5e1;cursor:pointer}
.table tbody tr{background:#0e131e;border:1px solid var(--line)}
.table tbody tr:nth-child(odd){background:#0d121c}
.table td{padding:10px;font-size:13px}
.table .actions{display:flex;gap:6px;flex-wrap:wrap}

/* KPI bars */
.kpiBar{height:10px;background:#0f1420;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.kpiBar > div{height:100%;background:#d1d5db}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
.modal.show{display:flex}
.modal .dialog{width:min(720px,96vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.modal .dialog h3{margin:0 0 10px;font-size:16px}
.modal .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

/* Calendar */
.cal{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);overflow:hidden}
.cal .cal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
.cal .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--line)}
.cal .wd{padding:8px 6px;background:#0e131e;font-size:12px;color:#cbd5e1}
.cal .cell{min-height:100px;background:#0d121c;padding:8px;position:relative;cursor:pointer}
.cal .cell .d{font-size:12px;color:#cbd5e1}
.cal .event{margin-top:6px;padding:4px 6px;border:1px solid var(--line);border-radius:8px;background:#101623;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cal .today{outline:2px solid #cbd5e1}
</style>
</head>
<body>

<div class="layout">
  <!-- SIDEBAR -->
  <aside>
    <div class="brand">
      <div class="brand-logo"></div>
      <div>
        <h1>Aegean Tech</h1>
        <div class="muted">Business Portal</div>
      </div>
    </div>

    <nav class="nav">
      <div class="item active" data-tab="dashboard">
        <svg fill="none" viewBox="0 0 24 24"><path d="M3 12h7V3H3v9Zm11 9h7V3h-7v18ZM3 21h7v-7H3v7Z" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Dashboard</span>
      </div>
      <div class="item" data-tab="proposals">
        <svg fill="none" viewBox="0 0 24 24"><path d="M5 3h9l5 5v13H5V3zm9 0v5h5" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Proposals</span>
      </div>
      <div class="item" data-tab="clients">
        <svg fill="none" viewBox="0 0 24 24"><path d="M16 11a4 4 0 1 0-8 0m12 8c0-3.314-3.582-6-8-6s-8 2.686-8 6" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Clients</span>
      </div>
      <div class="item" data-tab="templates">
        <svg fill="none" viewBox="0 0 24 24"><path d="M4 4h16v6H4zM4 14h16v6H4z" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Templates</span>
      </div>
      <div class="item" data-tab="calendar">
        <svg fill="none" viewBox="0 0 24 24"><path d="M7 3v4m10-4v4M3 9h18M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Calendar</span>
      </div>
      <div class="item" data-tab="reporting">
        <svg fill="none" viewBox="0 0 24 24"><path d="M4 20V4m16 16H4m3-3v-5m6 5V7m6 10v-8" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Reporting</span>
      </div>
      <div class="item" data-tab="settings">
        <svg fill="none" viewBox="0 0 24 24"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm8-3.5a8 8 0 0 0-.2-1.8l2.1-1.6-2-3.5-2.5 1a8.2 8.2 0 0 0-3.1-1.8L14.8 1h-5.6L8.7 3.3a8.2 8.2 0 0 0-3.1 1.8l-2.5-1-2 3.5 2.1 1.6A8 8 0 0 0 4 12c0 .6.07 1.2.2 1.8l-2.1 1.6 2 3.5 2.5-1a8.2 8.2 0 0 0 3.1 1.8L9.2 23h5.6l.5-2.3a8.2 8.2 0 0 0 3.1-1.8l2.5 1 2-3.5-2.1-1.6c.13-.6.2-1.2.2-1.8Z" stroke="currentColor" stroke-width="1.1"/></svg>
        <span>Settings</span>
      </div>
    </nav>
  </aside>

  <!-- MAIN -->
  <main>
    <div class="top">
      <strong id="title">Dashboard</strong>
      <div>
        <span class="note" id="userEmail">Not signed in</span>
        <button id="logoutBtn" class="btn small">Logout</button>
      </div>
    </div>

    <div class="container">

      <!-- LOGIN -->
      <section id="view-login" class="card">
        <div class="headerline">
          <h2>Sign in</h2>
          <span class="note">Users are in <code class="note">AEG_USERS</code></span>
        </div>
        <div class="row">
          <div class="col"><input id="email" placeholder="Email" value="admin@aegeantech.com"/></div>
          <div class="col"><input id="password" placeholder="Password" type="password"/></div>
          <div class="col"><button id="loginBtn" class="btn">Login</button></div>
        </div>
      </section>

      <!-- APP -->
      <section id="view-app" class="hidden">

        <!-- DASHBOARD -->
        <section id="tab-dashboard" class="card">
          <div class="headerline">
            <h2>Dashboard</h2>
            <div class="row">
              <button class="btn" id="openNewClient">ï¼‹ New Client</button>
              <button class="btn" id="openNewProposal">ï¼‹ New Proposal</button>
              <button class="btn" id="openNewTemplate">â†‘ Upload Template</button>
              <button class="btn" id="openNewMeeting">ðŸ“… New Meeting</button>
            </div>
          </div>

          <div class="row">
            <div class="col card">
              <h3>KPIs</h3>
              <div class="row">
                <div class="col">
                  <div class="note">Clients</div>
                  <div class="kpiBar"><div id="kpiClientsBar" style="width:0%"></div></div>
                  <div id="kpiClients" style="margin-top:6px;font-weight:800">0</div>
                </div>
                <div class="col">
                  <div class="note">Pipeline (â‚¬)</div>
                  <div class="kpiBar"><div id="kpiPipelineBar" style="width:0%"></div></div>
                  <div id="kpiPipeline" style="margin-top:6px;font-weight:800">0</div>
                </div>
                <div class="col">
                  <div class="row" style="margin-top:8px">
                    <span class="badge">draft <strong id="kpiDraft">0</strong></span>
                    <span class="badge">sent <strong id="kpiSent">0</strong></span>
                    <span class="badge">won <strong id="kpiWon">0</strong></span>
                    <span class="badge">lost <strong id="kpiLost">0</strong></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col card">
              <h3>Upcoming Meetings</h3>
              <ul id="kpiUpcoming" style="padding-left:18px;margin:6px 0 0"></ul>
            </div>
            <div class="col card">
              <h3>Activity Log</h3>
              <ul id="activityLog" style="padding-left:18px;margin:6px 0 0"></ul>
              <div class="note">Shows recent actions; requires `/api/activities` (present in your backend).</div>
            </div>
          </div>
        </section>

        <!-- PROPOSALS -->
        <section id="tab-proposals" class="card hidden">
          <div class="headerline">
            <h2>Proposals</h2>
            <div class="row">
              <input id="propSearch" placeholder="Search titleâ€¦"/>
              <select id="propFilterStatus"><option value="">All</option><option>draft</option><option>sent</option><option>won</option><option>lost</option></select>
              <button class="btn" id="propRefresh">Refresh</button>
              <button class="btn" id="openNewProposal2">ï¼‹ New</button>
            </div>
          </div>

          <div class="card">
            <div class="headerline">
              <h3>Folders (Assets Library)</h3>
              <div class="row">
                <input id="propFolderNew" placeholder="Create folder (e.g., contracts)"/>
                <button class="btn" id="propFolderAdd">Add Folder</button>
              </div>
            </div>
            <div id="propFolders" class="row"></div>
            <div style="height:8px"></div>
            <div class="row">
              <div class="col"><input id="propAssetFile" type="file" multiple/></div>
              <div class="col"><select id="propFolderSel"></select></div>
              <div class="col"><button class="btn" id="propAssetUpload">Upload to Folder</button></div>
            </div>
            <div style="height:8px"></div>
            <table class="table" id="propAssetsTable">
              <thead><tr><th data-col="id">ID</th><th data-col="folder">Folder</th><th data-col="filename">Filename</th><th data-col="size_bytes">Size</th><th data-col="created_at">Uploaded</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <table class="table" id="proposalsTable">
            <thead>
              <tr>
                <th data-col="id">ID</th>
                <th data-col="client_id">Client</th>
                <th data-col="title">Title</th>
                <th data-col="category">Category</th>
                <th data-col="status">Status</th>
                <th data-col="value_amount">â‚¬</th>
                <th data-col="due_date">Due</th>
                <th data-col="file">File</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- CLIENTS -->
        <section id="tab-clients" class="card hidden">
          <div class="headerline">
            <h2>Clients</h2>
            <div class="row">
              <input id="clientSearch" placeholder="Search name/contactâ€¦"/>
              <button class="btn" id="clientRefresh">Refresh</button>
              <button class="btn" id="openNewClient2">ï¼‹ New</button>
            </div>
          </div>

          <table class="table" id="clientsTable">
            <thead><tr><th data-col="id">ID</th><th data-col="name">Name</th><th data-col="industry">Industry</th><th data-col="contact">Contact</th><th></th></tr></thead>
            <tbody></tbody>
          </table>

          <div style="height:8px"></div>
          <div class="card">
            <div class="headerline">
              <h3>Client Files & Folders</h3>
              <div class="row">
                <select id="clientSel"></select>
                <input id="clientFolderNew" placeholder="Create folder (e.g., invoices, media)"/>
                <button class="btn" id="clientFolderAdd">Add Folder</button>
              </div>
            </div>
            <div id="clientFolders" class="row"></div>
            <div style="height:8px"></div>
            <div class="row">
              <div class="col"><input id="clientFile" type="file" multiple/></div>
              <div class="col"><select id="clientFolderSel"></select></div>
              <div class="col"><button class="btn" id="clientUploadBtn">Upload to Folder</button></div>
            </div>
            <div style="height:8px"></div>
            <table class="table" id="clientFilesTable">
              <thead><tr><th data-col="id">ID</th><th data-col="folder">Folder</th><th data-col="filename">Filename</th><th data-col="size_bytes">Size</th><th data-col="created_at">Uploaded</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- TEMPLATES -->
        <section id="tab-templates" class="card hidden">
          <div class="headerline">
            <h2>Templates Library</h2>
            <div class="row">
              <input id="tplSearch" placeholder="Search filenameâ€¦"/>
              <button class="btn" id="tplRefresh">Refresh</button>
              <button class="btn" id="openNewTemplate2">â†‘ Upload</button>
            </div>
          </div>

          <div class="card">
            <div class="headerline">
              <h3>Folders</h3>
              <div class="row">
                <input id="tplFolderNew" placeholder="Create folder (e.g., sales, legal)"/>
                <button class="btn" id="tplFolderAdd">Add Folder</button>
              </div>
            </div>
            <div id="tplFolders" class="row"></div>
            <div style="height:8px"></div>
            <div class="row">
              <div class="col"><input id="tplFile" type="file" multiple/></div>
              <div class="col"><select id="tplFolderSel"></select></div>
              <div class="col"><button class="btn" id="tplUploadBtn">Upload to Folder</button></div>
            </div>
            <div style="height:8px"></div>
            <table class="table" id="templatesTable">
              <thead><tr><th data-col="id">ID</th><th data-col="folder">Folder</th><th data-col="filename">Filename</th><th data-col="size_bytes">Size</th><th data-col="created_at">Uploaded</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- CALENDAR -->
        <section id="tab-calendar" class="card hidden">
          <div class="headerline">
            <h2>Calendar</h2>
            <div class="row">
              <button class="btn" id="openNewMeeting2">ï¼‹ New Meeting</button>
              <button class="btn" id="calToday">Today</button>
            </div>
          </div>

          <div class="cal">
            <div class="cal-head">
              <button class="btn small" id="calPrev">â€¹</button>
              <div><strong id="calLabel">Month YYYY</strong></div>
              <button class="btn small" id="calNext">â€º</button>
            </div>
            <div class="cal-grid" id="calGrid">
              <!-- Weekday heads -->
            </div>
          </div>
          <div class="note" style="margin-top:8px">Click a day to add a meeting. Meetings come from `/api/meetings`.</div>
        </section>

        <!-- REPORTING -->
        <section id="tab-reporting" class="card hidden">
          <div class="headerline"><h2>Reporting</h2></div>
          <div class="row">
            <div class="col card">
              <h3>Summary</h3>
              <div class="row">
                <div class="col"><div class="badge">Clients <strong id="rClients">0</strong></div></div>
                <div class="col"><div class="badge">Pipeline â‚¬ <strong id="rPipeline">0</strong></div></div>
                <div class="col"><div class="badge">Draft <strong id="rDraft">0</strong></div></div>
                <div class="col"><div class="badge">Sent <strong id="rSent">0</strong></div></div>
                <div class="col"><div class="badge">Won <strong id="rWon">0</strong></div></div>
                <div class="col"><div class="badge">Lost <strong id="rLost">0</strong></div></div>
              </div>
            </div>
            <div class="col card">
              <h3>Upcoming meetings</h3>
              <ul id="rUpcoming" style="padding-left:18px;margin:6px 0"></ul>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="tab-settings" class="card hidden">
          <div class="headerline"><h2>Settings</h2></div>
          <div class="row">
            <div class="col card">
              <h3>Email (SMTP) Test</h3>
              <div class="row">
                <div class="col"><input id="testEmailTo" placeholder="Send test to"/></div>
                <div class="col"><button class="btn" id="sendTestEmailBtn">Send</button></div>
              </div>
              <div class="note">Requires SMTP_* env vars.</div>
            </div>
            <div class="col card">
              <h3>About</h3>
              <p class="note">Minimal monochrome UI with modal forms, sortable tables and calendar.</p>
            </div>
          </div>
        </section>

      </section>
    </div>
  </main>
</div>

<!-- MODALS -->
<div class="modal" id="modalClient">
  <div class="dialog">
    <h3>New Client</h3>
    <div class="row">
      <div class="col"><input id="mClientName" placeholder="Name"/></div>
      <div class="col"><input id="mClientIndustry" placeholder="Industry"/></div>
      <div class="col"><input id="mClientContact" placeholder="Contact"/></div>
    </div>
    <div class="footer">
      <button class="btn ghost" data-close="#modalClient">Cancel</button>
      <button class="btn" id="mClientSave">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="modalProposal">
  <div class="dialog">
    <h3>New Proposal</h3>
    <div class="row">
      <div class="col"><select id="mPropClient"></select></div>
      <div class="col"><input id="mPropTitle" placeholder="Title"/></div>
      <div class="col">
        <select id="mPropCategory"><option>Maritime</option><option>Yachting</option><option>Real Estate</option><option>Hospitality</option><option>Public</option><option>Enterprise</option></select>
      </div>
    </div>
    <div class="row">
      <div class="col"><select id="mPropStatus"><option>draft</option><option>sent</option><option>won</option><option>lost</option></select></div>
      <div class="col"><input id="mPropValue" type="number" step="0.01" placeholder="Value (â‚¬)"/></div>
      <div class="col"><input id="mPropDue" type="date"/></div>
    </div>
    <div class="row">
      <div class="col"><input id="mPropFile" type="file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.png,.jpg,.jpeg"/></div>
    </div>
    <div class="footer">
      <button class="btn ghost" data-close="#modalProposal">Cancel</button>
      <button class="btn" id="mPropSave">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="modalTemplate">
  <div class="dialog">
    <h3>Upload Template</h3>
    <div class="row">
      <div class="col"><input id="mTplFile" type="file"/></div>
      <div class="col"><input id="mTplFolder" placeholder="Folder (default: general)"/></div>
    </div>
    <div class="footer">
      <button class="btn ghost" data-close="#modalTemplate">Cancel</button>
      <button class="btn" id="mTplSave">Upload</button>
    </div>
  </div>
</div>

<div class="modal" id="modalMeeting">
  <div class="dialog">
    <h3>New Meeting</h3>
    <div class="row">
      <div class="col"><input id="mMeetTitle" placeholder="Title"/></div>
      <div class="col"><input id="mMeetStart" type="datetime-local"/></div>
      <div class="col"><input id="mMeetDuration" type="number" min="15" step="15" value="60" placeholder="Duration (min)"/></div>
    </div>
    <div class="row">
      <div class="col"><input id="mMeetLocation" placeholder="Location"/></div>
      <div class="col"><input id="mMeetParticipants" placeholder="Emails comma-separated"/></div>
      <div class="col"><input id="mMeetRemind" type="number" min="0" value="30" placeholder="Remind before (min)"/></div>
    </div>
    <div class="footer">
      <button class="btn ghost" data-close="#modalMeeting">Cancel</button>
      <button class="btn" id="mMeetSave">Save</button>
    </div>
  </div>
</div>

<!-- App JS -->
<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function toast(msg){ let t=$('.toast'); if(!t){ t=document.createElement('div'); t.className='toast'; document.body.appendChild(t);} t.textContent=msg; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,2200); }
function bytes(n){ n=Number(n||0); if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+' MB'; return (n/1024/1024/1024).toFixed(1)+' GB'; }
function fmtDate(d){ return d.toISOString().slice(0,10); }

const state = {
  token: localStorage.getItem('token') || '',
  email: localStorage.getItem('email') || '',
  active: 'dashboard',
  clients: [],
  meetings: [],
  cal: new Date()
};

async function api(path, opts={}){
  opts.headers = Object.assign({"Authorization":"Bearer "+state.token}, opts.headers||{});
  const r = await fetch(path, opts);
  if(r.status===401){ logout(); throw new Error('Unauthorized'); }
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : r.text();
}

/* Auth */
function showApp(){ $('#view-login').classList.add('hidden'); $('#view-app').classList.remove('hidden'); }
function showLogin(){ $('#view-app').classList.add('hidden'); $('#view-login').classList.remove('hidden'); }
$('#loginBtn').onclick = async ()=>{
  const email=$('#email').value.trim(), password=$('#password').value.trim();
  const r = await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
  if(!r.ok){ toast('Login failed'); return; }
  const data = await r.json();
  state.token=data.token; state.email=data.email; localStorage.setItem('token',state.token); localStorage.setItem('email',state.email);
  $('#userEmail').textContent=state.email; showApp(); setTab('dashboard'); refreshAll();
};
$('#logoutBtn').onclick = logout;
function logout(){ localStorage.removeItem('token'); localStorage.removeItem('email'); state.token=''; state.email=''; $('#userEmail').textContent='Not signed in'; showLogin(); }

/* Tabs */
function setTab(id){
  state.active=id;
  $('#title').textContent = id.charAt(0).toUpperCase()+id.slice(1);
  $$('#view-app > section').forEach(s=> s.classList.toggle('hidden', s.id!==`tab-${id}`));
  $$('.nav .item').forEach(i=> i.classList.toggle('active', i.dataset.tab===id));
  if(id==='calendar'){ renderCalendar(); }
}
$$('.nav .item').forEach(i=> i.onclick = ()=> setTab(i.dataset.tab));

/* Dashboard & Reporting */
async function refreshKPIs(){
  const k = await api('/api/reporting/kpis');
  $('#kpiClients').textContent = k.clients;
  $('#kpiPipeline').textContent = k.pipeline_value;
  $('#kpiDraft').textContent = k.proposals.draft;
  $('#kpiSent').textContent  = k.proposals.sent;
  $('#kpiWon').textContent   = k.proposals.won;
  $('#kpiLost').textContent  = k.proposals.lost;
  $('#kpiClientsBar').style.width = Math.min(100, (k.clients||0)*10)+'%';
  $('#kpiPipelineBar').style.width = Math.min(100, (k.pipeline_value||0)/1000)+'%';
  $('#kpiUpcoming').innerHTML = (k.upcoming_meetings||[]).map(m=>`<li><strong>${m.title}</strong> â€” ${m.start_at}${m.location?(' â€¢ '+m.location):''}</li>`).join('');
  $('#rClients').textContent = k.clients;
  $('#rPipeline').textContent = k.pipeline_value;
  $('#rDraft').textContent = k.proposals.draft; $('#rSent').textContent = k.proposals.sent; $('#rWon').textContent = k.proposals.won; $('#rLost').textContent = k.proposals.lost;
  $('#rUpcoming').innerHTML = $('#kpiUpcoming').innerHTML;
  try{
    const acts = await api('/api/activities?limit=15');
    $('#activityLog').innerHTML = (acts||[]).map(a=>`<li><span class="note">${(a.created_at||'').slice(0,19).replace('T',' ')}</span> â€” <strong>${a.actor||'system'}</strong> ${a.action} <span class="note">(${a.entity}${a.entity_id?(' #'+a.entity_id):''})</span></li>`).join('');
  }catch(e){ $('#activityLog').innerHTML = '<li class="note">No activity API yet</li>'; }
}

/* Helpers: Table sorting */
function makeSortable(tableSelector){
  const table = $(tableSelector); if(!table) return;
  const ths = table.querySelectorAll('thead th[data-col]');
  let sortKey=null, sortDir=1;
  ths.forEach(th=>{
    th.onclick = ()=>{
      const key = th.dataset.col;
      sortDir = (sortKey===key) ? -sortDir : 1;
      sortKey = key;
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      rows.sort((a,b)=>{
        const va = a.querySelector(`[data-col="${key}"]`)?.textContent || a.children[Array.from(ths).indexOf(th)].textContent;
        const vb = b.querySelector(`[data-col="${key}"]`)?.textContent || b.children[Array.from(ths).indexOf(th)].textContent;
        const na = parseFloat(va.replace(/[^\d.-]/g,'')); const nb = parseFloat(vb.replace(/[^\d.-]/g,''));
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return (na-nb)*sortDir;
        return va.localeCompare(vb)*sortDir;
      });
      const tb = table.querySelector('tbody'); tb.innerHTML=''; rows.forEach(r=>tb.appendChild(r));
    };
  });
}

/* Clients */
async function loadClients(){
  const rows = await api('/api/clients');
  state.clients = rows || [];
  // Filter
  const q = ($('#clientSearch').value||'').toLowerCase();
  const data = q ? state.clients.filter(c=>(c.name||'').toLowerCase().includes(q) || (c.contact||'').toLowerCase().includes(q)) : state.clients;
  $('#clientsTable tbody').innerHTML = data.map(r=>`
    <tr>
      <td data-col="id">${r.id}</td>
      <td data-col="name">${r.name||''}</td>
      <td data-col="industry">${r.industry||''}</td>
      <td data-col="contact">${r.contact||''}</td>
      <td class="actions">
        <button class="btn small" data-edit="${r.id}">Edit</button>
        <button class="btn small" data-del="${r.id}">Delete</button>
      </td>
    </tr>`).join('');
  makeSortable('#clientsTable');
  // bindings
  $$('#clientsTable [data-del]').forEach(b=> b.onclick = async ()=>{ if(!confirm('Delete client?'))return; await api('/api/clients/'+b.dataset.del,{method:'DELETE'}); await loadClients(); await refreshKPIs(); });
  $$('#clientsTable [data-edit]').forEach(b=> b.onclick = ()=>{
    const c = state.clients.find(x=>x.id==b.dataset.edit);
    openModal('#modalClient');
    $('#mClientName').value=c.name||''; $('#mClientIndustry').value=c.industry||''; $('#mClientContact').value=c.contact||'';
    $('#mClientSave').dataset.id = c.id;
  });
  // selector for file manager
  $('#clientSel').innerHTML = state.clients.map(c=>`<option value="${c.id}">${c.id} â€” ${c.name}</option>`).join('');
}
$('#clientSearch').oninput = loadClients;
$('#clientRefresh').onclick = loadClients;

async function refreshClientFolders(){
  const id = $('#clientSel').value;
  try{
    const folders = await api(`/api/clients/${id}/folders`);
    state.clientFolders = new Set(folders && folders.length ? folders : ['general']);
  }catch{ state.clientFolders = new Set(['general']); }
  const arr = Array.from(state.clientFolders);
  $('#clientFolders').innerHTML = arr.map(f=>`<span class="badge">${f}</span>`).join(' ');
  $('#clientFolderSel').innerHTML = arr.map(f=>`<option>${f}</option>`).join('');
}
$('#clientFolderAdd').onclick = ()=>{
  const v = $('#clientFolderNew').value.trim(); if(!v) return;
  state.clientFolders.add(v); $('#clientFolderNew').value=''; refreshClientFolders();
};
$('#clientUploadBtn').onclick = async ()=>{
  const id=$('#clientSel').value, folder=$('#clientFolderSel').value||'general', files=$('#clientFile').files;
  if(!files.length) return toast('Choose files');
  for(const f of files){
    const fd=new FormData(); fd.append('file', f); fd.append('folder', folder);
    const r = await fetch(`/api/clients/${id}/files`,{method:'POST',headers:{'Authorization':'Bearer '+state.token},body:fd});
    if(!r.ok) return toast('Upload failed: '+f.name);
  }
  $('#clientFile').value=''; await loadClientFiles();
};
async function loadClientFiles(){
  const id = $('#clientSel').value;
  const rows = await api(`/api/clients/${id}/files`);
  $('#clientFilesTable tbody').innerHTML = (rows||[]).map(r=>`
    <tr>
      <td data-col="id">${r.id}</td>
      <td data-col="folder">${r.folder||'general'}</td>
      <td data-col="filename">${r.filename}</td>
      <td data-col="size_bytes">${bytes(r.size_bytes)}</td>
      <td data-col="created_at">${(r.created_at||'').slice(0,19).replace('T',' ')}</td>
      <td class="actions">
        <a class="btn small" href="/api/files/download/${r.id}" target="_blank">Download</a>
        <button class="btn small" data-del="${r.id}">Delete</button>
      </td>
    </tr>`).join('');
  makeSortable('#clientFilesTable');
  $$('#clientFilesTable [data-del]').forEach(b=> b.onclick = async ()=>{ await api('/api/files/'+b.dataset.del,{method:'DELETE'}); loadClientFiles(); });
}
$('#clientSel').onchange = ()=>{ refreshClientFolders(); loadClientFiles(); };

/* Client modal */
function openModal(sel){ $(sel).classList.add('show'); }
function closeModal(sel){ $(sel).classList.remove('show'); }
$$('[data-close]').forEach(btn=> btn.onclick = ()=> closeModal(btn.getAttribute('data-close')) );

$('#openNewClient,#openNewClient2').forEach ? null : null;
$('#openNewClient').onclick = ()=>{ delete $('#mClientSave').dataset.id; $('#mClientName').value=''; $('#mClientIndustry').value=''; $('#mClientContact').value=''; openModal('#modalClient'); };
$('#openNewClient2').onclick = $('#openNewClient').onclick;

$('#mClientSave').onclick = async (e)=>{
  const id = e.target.dataset.id;
  const name=$('#mClientName').value.trim(), industry=$('#mClientIndustry').value.trim(), contact=$('#mClientContact').value.trim();
  if(!name) return toast('Name required');
  if(id){
    await api('/api/clients/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,industry,contact})});
  }else{
    await api('/api/clients',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,industry,contact})});
  }
  closeModal('#modalClient'); await loadClients(); await refreshKPIs();
};

/* Proposals */
async function loadClientsIntoProposal(){
  const data = state.clients.length? state.clients : await api('/api/clients');
  state.clients = data;
  $('#mPropClient').innerHTML = (data||[]).map(c=>`<option value="${c.id}">${c.id} â€” ${c.name}</option>`).join('');
}
async function renderProposals(){
  let rows = await api('/api/proposals');
  const q = ($('#propSearch').value||'').toLowerCase();
  const st = $('#propFilterStatus').value||'';
  if(q) rows = rows.filter(p=>(p.title||'').toLowerCase().includes(q));
  if(st) rows = rows.filter(p=>p.status===st);
  $('#proposalsTable tbody').innerHTML = (rows||[]).map(p=>`
    <tr>
      <td data-col="id">${p.id}</td>
      <td data-col="client_id">${p.client_id}</td>
      <td data-col="title">${p.title}</td>
      <td data-col="category">${p.category}</td>
      <td data-col="status">${p.status}</td>
      <td data-col="value_amount">${Number(p.value_amount||0).toFixed(2)}</td>
      <td data-col="due_date">${p.due_date||''}</td>
      <td>${p.file_id?`<a href="/api/proposals/download/${p.id}" target="_blank">Download</a>`:''}</td>
      <td class="actions"><button class="btn small" data-del="${p.id}">Delete</button></td>
    </tr>`).join('');
  makeSortable('#proposalsTable');
  $$('#proposalsTable [data-del]').forEach(b=> b.onclick = async ()=>{ if(!confirm('Delete proposal?'))return; await api('/api/proposals/'+b.dataset.del,{method:'DELETE'}); renderProposals(); refreshKPIs(); });
}
$('#propRefresh').onclick = renderProposals;
$('#propSearch').oninput = renderProposals;
$('#propFilterStatus').onchange = renderProposals;
$('#openNewProposal,#openNewProposal2').forEach ? null : null;
$('#openNewProposal').onclick = async ()=>{ await loadClientsIntoProposal(); $('#mPropTitle').value=''; $('#mPropValue').value=''; $('#mPropDue').value=''; $('#mPropFile').value=''; openModal('#modalProposal'); };
$('#openNewProposal2').onclick = $('#openNewProposal').onclick;

$('#mPropSave').onclick = async ()=>{
  const client_id=$('#mPropClient').value, title=$('#mPropTitle').value.trim();
  const category=$('#mPropCategory').value, status=$('#mPropStatus').value;
  const value_amount=$('#mPropValue').value, due_date=$('#mPropDue').value || null;
  if(!client_id || !title) return toast('Client & Title required');
  const f = $('#mPropFile').files[0];
  if(f){
    const form=new FormData();
    form.append('client_id', client_id); form.append('title', title);
    form.append('category', category); form.append('status', status);
    form.append('value_amount', value_amount); form.append('currency', 'EUR');
    if(due_date) form.append('due_date', due_date);
    form.append('file', f);
    const r = await fetch('/api/proposals',{method:'POST',headers:{'Authorization':'Bearer '+state.token},body:form});
    if(!r.ok){ toast('Failed to add'); return; }
  } else {
    await api('/api/proposals',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({client_id,title,category,status,value_amount,currency:'EUR',due_date})});
  }
  closeModal('#modalProposal'); renderProposals(); refreshKPIs();
};

/* Proposal assets folders */
function chipList(el, arr){ el.innerHTML = arr.map(f=>`<span class="badge">${f}</span>`).join(' '); }
async function loadProposalFolders(){
  try{
    const folders = await api('/api/proposals/folders');
    state.propFolders = new Set(folders && folders.length? folders : ['general']);
  }catch{ state.propFolders = new Set(['general']); }
  const a = Array.from(state.propFolders);
  chipList($('#propFolders'), a);
  $('#propFolderSel').innerHTML = a.map(f=>`<option>${f}</option>`).join('');
}
$('#propFolderAdd').onclick = ()=>{
  const v = ($('#propFolderNew').value||'').trim(); if(!v) return;
  state.propFolders.add(v); $('#propFolderNew').value=''; loadProposalFolders();
};
$('#propAssetUpload').onclick = async ()=>{
  const folder=$('#propFolderSel').value||'general', files=$('#propAssetFile').files;
  if(!files.length) return toast('Choose files');
  for(const f of files){
    const fd=new FormData(); fd.append('file', f); fd.append('folder', folder);
    const r = await fetch('/api/proposals/assets',{method:'POST',headers:{'Authorization':'Bearer '+state.token},body:fd});
    if(!r.ok) return toast('Upload failed: '+f.name);
  }
  $('#propAssetFile').value=''; loadProposalAssets();
};
async function loadProposalAssets(){
  try{
    const rows = await api('/api/proposals/assets');
    $('#propAssetsTable tbody').innerHTML = (rows||[]).map(r=>`
      <tr>
        <td data-col="id">${r.id}</td>
        <td data-col="folder">${r.folder||'general'}</td>
        <td data-col="filename">${r.filename}</td>
        <td data-col="size_bytes">${bytes(r.size_bytes)}</td>
        <td data-col="created_at">${(r.created_at||'').slice(0,19).replace('T',' ')}</td>
        <td class="actions"><a class="btn small" href="/api/files/download/${r.id}" target="_blank">Download</a></td>
      </tr>`).join('');
    makeSortable('#propAssetsTable');
  }catch{ $('#propAssetsTable tbody').innerHTML = `<tr><td colspan="6" class="note">Proposal assets API not available yet</td></tr>`; }
}

/* Templates with modal upload */
$('#openNewTemplate,#openNewTemplate2').forEach ? null : null;
$('#openNewTemplate').onclick = ()=>{ $('#mTplFile').value=''; $('#mTplFolder').value=''; openModal('#modalTemplate'); };
$('#openNewTemplate2').onclick = $('#openNewTemplate').onclick;

async function loadTemplateFolders(){
  try{
    const folders = await api('/api/templates/folders');
    state.tplFolders = new Set(folders && folders.length? folders : ['general']);
  }catch{ state.tplFolders = new Set(['general']); }
  const a = Array.from(state.tplFolders);
  chipList($('#tplFolders'), a);
  $('#tplFolderSel').innerHTML = a.map(f=>`<option>${f}</option>`).join('');
}
$('#tplFolderAdd').onclick = ()=>{
  const v = ($('#tplFolderNew').value||'').trim(); if(!v) return;
  state.tplFolders.add(v); $('#tplFolderNew').value=''; loadTemplateFolders();
};
$('#mTplSave').onclick = async ()=>{
  const f = $('#mTplFile').files[0]; if(!f) return toast('Choose a file');
  const folder = ($('#mTplFolder').value||'general').trim();
  const fd=new FormData(); fd.append('file', f); fd.append('folder', folder);
  let r = await fetch('/api/templates/upload2',{method:'POST',headers:{'Authorization':'Bearer '+state.token},body:fd});
  if(!r.ok){ // fallback
    const fd2=new FormData(); fd2.append('file', f);
    r = await fetch('/api/templates/upload',{method:'POST',headers:{'Authorization':'Bearer '+state.token},body:fd2});
    if(!r.ok) return toast('Upload failed');
  }
  closeModal('#modalTemplate'); renderTemplates();
};
$('#tplUploadBtn').onclick = async ()=>{
  const files=$('#tplFile').files; if(!files.length) return toast('Choose files');
  const folder=$('#tplFolderSel').value||'general';
  for(const f of files){
    const fd=new FormData(); fd.append('file', f); fd.append('folder', folder);
    let r = await fetch('/api/templates/upload2',{method:'POST',headers:{'Authorization':'Bearer '+state.token},body:fd});
    if(!r.ok){ const fd2=new FormData(); fd2.append('file', f); r = await fetch('/api/templates/upload',{method:'POST',headers:{'Authorization':'Bearer '+state.token},body:fd2}); if(!r.ok) return toast('Upload failed: '+f.name); }
  }
  $('#tplFile').value=''; renderTemplates();
};
async function renderTemplates(){
  let rows=null; try{ rows = await api('/api/templates/list2'); }catch(e){}
  if(!rows){ rows = await api('/api/templates'); }
  const q = ($('#tplSearch').value||'').toLowerCase();
  if(q) rows = rows.filter(x=>(x.filename||'').toLowerCase().includes(q));
  $('#templatesTable tbody').innerHTML = (rows||[]).map(r=>`
    <tr>
      <td data-col="id">${r.id}</td>
      <td data-col="folder">${r.folder||'general'}</td>
      <td data-col="filename">${r.filename}</td>
      <td data-col="size_bytes">${bytes(r.size_bytes)}</td>
      <td data-col="created_at">${(r.created_at||'').slice(0,19).replace('T',' ')}</td>
      <td class="actions"><a class="btn small" href="/api/templates/download/${r.id}" target="_blank">Download</a></td>
    </tr>`).join('');
  makeSortable('#templatesTable');
}
$('#tplSearch').oninput = renderTemplates;
$('#tplRefresh').onclick = renderTemplates;

/* Calendar */
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
async function fetchMeetings(){ state.meetings = await api('/api/meetings'); }
function renderCalendar(){
  const base = new Date(state.cal.getFullYear(), state.cal.getMonth(), 1);
  const s = startOfMonth(base); const e = endOfMonth(base);
  const firstWeekday = (s.getDay()+6)%7; // Mon=0
  $('#calLabel').textContent = base.toLocaleString('default',{month:'long', year:'numeric'});
  const grid = $('#calGrid'); grid.innerHTML='';
  const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  weekdays.forEach(w=>{ const h=document.createElement('div'); h.className='wd'; h.textContent=w; grid.appendChild(h); });
  // blanks
  for(let i=0;i<firstWeekday;i++){ const c=document.createElement('div'); c.className='cell'; c.style.background='transparent'; c.style.cursor='default'; grid.appendChild(c); }
  const today = new Date();
  for(let day=1; day<=e.getDate(); day++){
    const d = new Date(base.getFullYear(), base.getMonth(), day);
    const c = document.createElement('div'); c.className='cell';
    if(sameDay(d,today)) c.classList.add('today');
    const label = document.createElement('div'); label.className='d'; label.textContent=String(day); c.appendChild(label);
    // events
    (state.meetings||[]).forEach(m=>{
      const md = new Date(m.start_at);
      if(sameDay(d, md)){
        const ev = document.createElement('div'); ev.className='event'; ev.title = m.title;
        ev.textContent = m.title;
        c.appendChild(ev);
      }
    });
    c.onclick = ()=>{
      // preset modal datetime to clicked day, 10:00
      const pad=x=>String(x).padStart(2,'0');
      $('#mMeetTitle').value='';
      const local = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 10, 0, 0);
      const localISO = local.toISOString().slice(0,16);
      $('#mMeetStart').value = localISO;
      $('#mMeetDuration').value = 60;
      $('#mMeetLocation').value = '';
      $('#mMeetParticipants').value = '';
      $('#mMeetRemind').value = 30;
      openModal('#modalMeeting');
    };
    grid.appendChild(c);
  }
}
$('#calPrev').onclick = ()=>{ state.cal.setMonth(state.cal.getMonth()-1); renderCalendar(); };
$('#calNext').onclick = ()=>{ state.cal.setMonth(state.cal.getMonth()+1); renderCalendar(); };
$('#calToday').onclick= ()=>{ state.cal = new Date(); renderCalendar(); };
$('#openNewMeeting,#openNewMeeting2').forEach ? null : null;
$('#openNewMeeting').onclick = ()=>{ $('#mMeetTitle').value=''; $('#mMeetStart').value=''; $('#mMeetDuration').value=60; $('#mMeetLocation').value=''; $('#mMeetParticipants').value=''; $('#mMeetRemind').value=30; openModal('#modalMeeting'); };
$('#openNewMeeting2').onclick = $('#openNewMeeting').onclick;
$('#mMeetSave').onclick = async ()=>{
  const title=$('#mMeetTitle').value.trim(), startLocal=$('#mMeetStart').value, duration_min=Number($('#mMeetDuration').value||60);
  const location=$('#mMeetLocation').value.trim(), participants=$('#mMeetParticipants').value.trim(), remind_before_min=Number($('#mMeetRemind').value||30);
  if(!title || !startLocal || !participants) return toast('Title, Start, Participants required');
  // Convert local datetime-local to ISO UTC
  const start = new Date(startLocal); const iso = new Date(start.getTime()-start.getTimezoneOffset()*60000).toISOString().replace('.000','');
  await api('/api/meetings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,start_at:iso,duration_min,location,participants,remind_before_min})});
  closeModal('#modalMeeting'); await fetchMeetings(); renderCalendar(); await refreshKPIs();
};

/* Settings */
$('#sendTestEmailBtn').onclick = async ()=>{
  const to = ($('#testEmailTo').value||'').trim() || state.email;
  const r = await api('/api/email/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to})});
  toast((r.ok?'Sent':'Failed') + (r.msg?(' â€¢ '+r.msg):'')); };

/* Proposal assets rendering hookup */
$('#propFolderNew').onkeyup = (e)=>{ if(e.key==='Enter') $('#propFolderAdd').click(); };

/* Initial boot */
async function refreshAll(){
  await refreshKPIs();
  await loadClients();
  $('#clientSel').dispatchEvent(new Event('change'));
  await renderProposals();
  await loadProposalFolders();
  await loadProposalAssets();
  await loadTemplateFolders();
  await renderTemplates();
  await fetchMeetings();
  if(state.active==='calendar') renderCalendar();
}
(function init(){
  if(state.token){
    $('#userEmail').textContent = state.email || 'Signed in';
    showApp(); setTab('dashboard'); refreshAll().catch(()=>{});
  }else{
    showLogin();
  }
})();
</script>
</body>
</html>
